<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KRA + Salary + Incentive + TDS Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0f0f0f;
  --card:#1b1b1b;
  --accent:#0b79d0;
  --green:#16a34a;
  --red:#b91c1c;
  --text:#eaeaea;
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:18px;
  font-family:Arial,system-ui;
  background:var(--bg);
  color:var(--text);
}
.wrap{
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}
.card{
  background:var(--card);
  padding:16px;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.4);
}
h2,h3{margin:0 0 10px}
label{font-size:13px;margin-top:8px;display:block}
input,select,button{
  padding:9px;
  border:1px solid #444;
  border-radius:8px;
  font-size:14px;
  background:#2a2a2a;
  color:var(--text);
}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  cursor:pointer;
}
button.secondary{background:#777}
.row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  table-layout:fixed;   /* FIX #1 */
}
th,td{
  border:1px solid #333;
  padding:8px;
  text-align:center;
}

/* Scroll Table — FIX #2 */
#kraTableBody{
  display:block;
  max-height:400px;
  overflow-y:auto;
  border:1px solid #444;
}

/* Actions column width — FIX #3 */
td:last-child, th:last-child {
  width:110px;
  min-width:110px;
}

/* Sticky Summary */
#totalSalary{
  position:sticky;
  bottom:0;
  background:#111;
  padding:10px;
  margin-top:10px;
  border-top:1px solid #444;
}

.result{margin-top:10px;font-weight:bold}
.muted{font-size:13px;color:#aaa}

@media(max-width:900px){
  .wrap{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="wrap">

<section class="card">
<h2>Talk Time & KRA Calculator</h2>

<button id="toggleBtn" onclick="toggleMode()">Switch to Auto Talk Time</button>

<div id="autoMode" style="display:none">
  <label>Calls Handled</label>
  <input id="calls" type="number">

  <div class="row">
    <div><label>Avg Talk Time (Minutes)</label><input id="minutes" type="number"></div>
    <div><label>Avg Talk Time (Seconds)</label><input id="seconds" type="number" max="59"></div>
  </div>
</div>

<div id="manualMode">
  <label>Total Talk Time (Minutes)</label>
  <input id="manualTT" type="number" step="0.01">
  <div class="muted">Example: 83.50</div>
</div>

<label>Effective CC</label>
<input id="effCC" type="number">

<button style="margin-top:10px" onclick="calculateKRA()">Calculate KRA</button>
<div class="result" id="kraResult">KRA: —</div>
<hr>

<label>Add Calculated KRA to Employee</label>
<select id="employeeSelect"></select>
<input type="date" id="kraDate">
<button onclick="addCalculated()">Add to Dashboard</button>
</section>

<section class="card">
<h2>Salary + Incentive Dashboard</h2>

<label>Select Employee</label>
<select id="employeeName" onchange="renderTable()"></select>

<div class="row">
  <input id="newEmployeeName" placeholder="New Employee Name">
  <button class="secondary" onclick="addNewEmployee()">Add Employee</button>
</div>

<hr>

<h3>Incentive (3% on Sale)</h3>
<div class="row">
  <input id="saleInput" type="number" placeholder="Total Sale ₹">
  <button onclick="addIncentive()">Add Incentive</button>
</div>
<div id="incInfo" class="muted"></div>

<table>
<thead>
<tr><th>Date</th><th>KRA%</th><th>Salary</th><th>Actions</th></tr>
</thead>
<tbody id="kraTableBody"></tbody>
</table>

<div class="result" id="totalSalary"></div>
<div class="muted">* 10% TDS deducted on total payout</div>
</section>

</div>

<script>
let data = JSON.parse(localStorage.getItem("kraData")||"[]");
let employees = JSON.parse(localStorage.getItem("kraEmployees")||'["Ritik","Abhishek","Vipul"]');
let incentives = JSON.parse(localStorage.getItem("kraIncentives")||"{}");

let manualMode=true,lastKRA=null;

function populateEmployees(){
  employeeName.innerHTML=employeeSelect.innerHTML="";
  employees.forEach(e=>{
    employeeName.innerHTML+=`<option>${e}</option>`;
    employeeSelect.innerHTML+=`<option>${e}</option>`;
  });
}
populateEmployees();renderTable();

function toggleMode(){
  manualMode=!manualMode;
  autoMode.style.display=manualMode?"none":"block";
  manualModeDiv=document.getElementById("manualMode");
  manualModeDiv.style.display=manualMode?"block":"none";
  toggleBtn.innerText=manualMode?"Switch to Auto Talk Time":"Switch to Manual Talk Time";
  kraResult.innerText="KRA: —";
}

function calculateKRA(){
  const cc=+effCC.value;if(!cc){alert("Enter Effective CC");return;}
  let totalMinutes=0;
  if(manualMode){
    totalMinutes=+manualTT.value;if(!totalMinutes){alert("Enter talk time");return;}
  }else{
    const c=+calls.value,m=+minutes.value||0,s=+seconds.value||0;
    if(!c){alert("Enter calls");return;}
    totalMinutes=c*((m*60+s)/60);
  }
  const kra=((cc/50)*0.5+(totalMinutes/240)*0.5)*100;
  lastKRA=+kra.toFixed(2);
  kraResult.innerText="KRA: "+lastKRA+"%";
}

function salaryFromKRA(k){
  if(k>=150)return 1100;
  if(k>=135)return 1000;
  if(k>=120)return 900;
  if(k>=100)return 750;
  if(k>=80)return 500;
  if(k>=60)return 300;
  return 0;
}

function addCalculated(){
  if(lastKRA===null){alert("Calculate KRA first");return;}
  const name=employeeSelect.value;
  let date=kraDate.value||new Date().toISOString().slice(0,10);
  if(data.some(d=>d.name===name&&d.date===date)){alert("Entry exists");return;}
  data.push({name,date,kra:lastKRA,salary:salaryFromKRA(lastKRA)});
  save();renderTable();
}

function addIncentive(){
  const sale=+saleInput.value;if(!sale){alert("Enter sale");return;}
  incentives[employeeName.value]=+(sale*0.03).toFixed(2);
  save();renderTable();
}

function addNewEmployee(){
  const n=newEmployeeName.value.trim();
  if(!n||employees.includes(n)){alert("Invalid/Exists");return;}
  employees.push(n);save();populateEmployees();
  employeeName.value=employeeSelect.value=n;
  newEmployeeName.value="";
}

function renderTable(){
  const emp=employeeName.value;
  const body=kraTableBody;
  const prevScroll=body.scrollTop;
  body.innerHTML="";
  let salaryTotal=0,days=new Set();

  data.filter(d=>d.name===emp).forEach(d=>{
    salaryTotal+=d.salary;days.add(d.date);
    body.innerHTML+=`
      <tr>
        <td>${d.date}</td>
        <td>${d.kra}</td>
        <td>₹${d.salary}</td>
        <td>
          <button onclick="editRow('${d.name}','${d.date}')">Edit</button>
          <button onclick="del('${d.name}','${d.date}')">Delete</button>
        </td>
      </tr>`;
  });

  body.scrollTop=prevScroll;

  const inc=incentives[emp]||0;
  const gross=+(salaryTotal+inc).toFixed(2); /* FIX floating */
  const tds=+(gross*0.10).toFixed(2);
  const net=+(gross-tds).toFixed(2);

  totalSalary.innerHTML=`
    Working Days: <b>${days.size}</b><br>
    Salary: ₹${salaryTotal}<br>
    Incentive: ₹${inc}<br><br>
    <b>Total (Before TDS): ₹${gross}</b><br>
    <span style="color:var(--red)">TDS (10%): -₹${tds}</span><br>
    <span style="color:var(--green);font-size:16px">
      Net Pay (After TDS): ₹${net}
    </span>
  `;
  incInfo.innerText=inc?`Incentive Added: ₹${inc}`:"No incentive added";
}

function del(n,d){data=data.filter(x=>!(x.name===n&&x.date===d));save();renderTable();}
function editRow(n,d){
  const i=data.find(x=>x.name===n&&x.date===d);
  if(!i)return;
  employeeName.value=employeeSelect.value=n;
  kraDate.value=d;lastKRA=i.kra;
  kraResult.innerText="KRA: "+lastKRA+"%";
  del(n,d);
}

function save(){
  localStorage.setItem("kraData",JSON.stringify(data));
  localStorage.setItem("kraEmployees",JSON.stringify(employees));
  localStorage.setItem("kraIncentives",JSON.stringify(incentives));
}
</script>
</body>
</html>